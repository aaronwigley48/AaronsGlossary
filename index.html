<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aaronâ€™s Glossary</title>
  <style>
    :root { color-scheme: light dark; }

    body{
      font-family: system-ui, Segoe UI, Arial, sans-serif;
      max-width: 760px; margin:24px auto; padding:0 16px; line-height:1.45;
    }
    header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
    form{ display:grid; gap:12px; margin:16px 0; }
    input,textarea{ padding:10px; border:1px solid #ddd; border-radius:8px; font:inherit; }
    textarea{ resize:vertical; }
    button{ padding:10px 14px; border:0; border-radius:10px; cursor:pointer; font:inherit;
            background:#2563eb; color:#fff; transition:transform .15s, box-shadow .15s, opacity .15s; }
    button:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(37,99,235,.25); }
    button:disabled{ opacity:.6; cursor:progress; box-shadow:none; }
    button.secondary{ background:#e5e7eb; color:#111827; }
    button.danger{ background:#dc2626; }
    .form-actions{ display:flex; gap:8px; justify-content:flex-end; }
    .header-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden;
              clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    #search{ margin:12px 0; }
    #tagFilters{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; }
    .tag-filter{ background:#f3f4f6; color:#1f2937; border-radius:999px; padding:6px 12px; border:1px solid transparent; }
    .tag-filter.active{ background:#2563eb; color:#fff; border-color:#1d4ed8; }
    ul{ list-style:none; padding:0; }
    li{ padding:12px; border:1px solid #eee; border-radius:10px; margin:8px 0; background:rgba(255,255,255,.75);
        box-shadow:0 1px 3px rgba(15,23,42,.08); }
    .item-actions{ display:flex; gap:8px; margin-top:12px; }
    .tags{ font-size:12px; color:#4b5563; text-transform:uppercase; letter-spacing:.08em; }
    .empty{ text-align:center; color:#6b7280; font-style:italic; background:transparent; box-shadow:none; border-style:dashed; }

    @media (prefers-color-scheme: dark){
      body{ background:#0f172a; color:#f8fafc; }
      input,textarea{ background:#0f172a; color:inherit; border-color:#1e293b; }
      li{ background:rgba(15,23,42,.85); border-color:#1e293b; }
      .tags{ color:#cbd5f5; }
      .tag-filter{ background:rgba(148,163,184,.35); color:#e2e8f0; }
    }
  </style>
</head>
<body>

<header>
  <h1>Aaronâ€™s Glossary</h1>
  <div class="header-actions">
    <button id="importExcel" type="button" class="secondary">Import Excel</button>
    <input id="excelFile" type="file" accept=".xlsx,.xls,.csv" class="sr-only" />
    <button id="exportExcel" type="button" class="secondary">Export Excel</button>
    <button id="signin">Sign in</button>
    <button id="signout" style="display:none;">Sign out</button>
  </div>
</header>

<form id="entryForm">
  <input id="term" placeholder="Term (e.g. Epikarst)" required />
  <textarea id="definition" placeholder="Definition" rows="4" required></textarea>
  <textarea id="notes" placeholder="Notes (optional)" rows="2"></textarea>
  <input id="tags" placeholder="Tags (comma-separated)" />
  <div class="form-actions">
    <button type="submit" id="submitBtn">Save</button>
    <button type="button" id="cancelEdit" class="secondary" style="display:none;">Cancel</button>
  </div>
</form>

<input id="search" placeholder="Searchâ€¦" />
<div id="tagFilters"></div>
<ul id="list"></ul>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, signInAnonymously, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    onSnapshot, query, orderBy, doc, deleteDoc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
  import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.19.3/+esm";

  // ðŸ”§ YOUR FIREBASE CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyDMiNg7Uv4HcEm_zJQ0ZuwVztUGIquYr7E",
    authDomain: "wigleyglossary.firebaseapp.com",
    projectId: "wigleyglossary",
    storageBucket: "wigleyglossary.appspot.com",
    messagingSenderId: "613114856859",
    appId: "1:613114586589:web:47a746c83dfd7f7d10cd3e",
    measurementId: "G-8QL63QGGX1"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // UI refs
  const btnSignIn = document.getElementById('signin');
  const btnSignOut = document.getElementById('signout');
  const btnImport = document.getElementById('importExcel');
  const btnExport = document.getElementById('exportExcel');
  const fileInput = document.getElementById('excelFile');
  const form = document.getElementById('entryForm');
  const list = document.getElementById('list');
  const search = document.getElementById('search');
  const tagFilters = document.getElementById('tagFilters');
  const btnSubmit = document.getElementById('submitBtn');
  const btnCancelEdit = document.getElementById('cancelEdit');
  const termInput = document.getElementById('term');
  const definitionInput = document.getElementById('definition');
  const notesInput = document.getElementById('notes');
  const tagsInput = document.getElementById('tags');

  let uid = null;
  let unsubscribe = null;
  let items = [];
  let editingId = null;
  let selectedTag = null;

  btnImport.disabled = true;
  btnExport.disabled = true;

  // ----- helpers -----
  const esc = s => String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");

  const linkify = input =>
    String(input ?? "").replace(/(https?:\/\/[^\s<]+)/g, url =>
      `<a href="${url.replace(/"/g,"&quot;")}" target="_blank" rel="noopener">${url}</a>`
    );

  const rich = (text, {italic=false}={}) => {
    const html = linkify(esc(text)).replace(/\n/g,"<br/>");
    return italic ? `<em>${html}</em>` : html;
  };

  const uniqueTags = () => {
    const set = new Set();
    for (const e of items) (e.tags||[]).forEach(t => set.add(t));
    return [...set].sort((a,b)=>a.localeCompare(b));
  };

  function renderTagFilters() {
    const tags = uniqueTags();
    tagFilters.innerHTML = "";
    tagFilters.style.display = tags.length ? "flex" : "none";

    if (!tags.length) return;

    const allBtn = document.createElement("button");
    allBtn.type = "button";
    allBtn.textContent = "All tags";
    allBtn.className = `tag-filter${selectedTag ? "" : " active"}`;
    allBtn.dataset.tag = "";
    tagFilters.appendChild(allBtn);

    for (const t of tags) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = t;
      btn.className = `tag-filter${selectedTag===t ? " active" : ""}`;
      btn.dataset.tag = t;
      tagFilters.appendChild(btn);
    }
  }

  function cancelEdit() {
    editingId = null;
    form.reset();
    btnSubmit.textContent = "Save";
    btnSubmit.disabled = false;
    btnCancelEdit.style.display = "none";
  }

  function beginEdit(entry) {
    editingId = entry.id;
    termInput.value = entry.term;
    definitionInput.value = entry.definition;
    notesInput.value = entry.notes || "";
    tagsInput.value = (entry.tags || []).join(", ");
    btnSubmit.textContent = "Update";
    btnCancelEdit.style.display = "inline-flex";
    termInput.focus();
    termInput.scrollIntoView({behavior:"smooth", block:"center"});
  }

  function render() {
    const q = search.value.trim().toLowerCase();

    const filtered = items.filter(e => {
      const hit =
        e.term.toLowerCase().includes(q) ||
        e.definition.toLowerCase().includes(q) ||
        (e.notes||"").toLowerCase().includes(q) ||
        e.tags.join(" ").toLowerCase().includes(q);
      return hit;
    });

    const finalList = selectedTag
      ? filtered.filter(e => (e.tags||[]).includes(selectedTag))
      : filtered;

    btnExport.disabled = !uid || !items.length;

    list.innerHTML = "";
    if (!finalList.length) {
      const li = document.createElement("li");
      li.className = "empty";
      li.textContent = items.length
        ? "No entries match your search or filters yet."
        : "You haven't added any entries yet. Start by adding a new term above.";
      list.appendChild(li);
      return;
    }

    for (const e of finalList) {
      const li = document.createElement("li");
      li.innerHTML = `
        <strong>${esc(e.term)}</strong><br/>
        ${rich(e.definition)}<br/>
        ${e.notes ? `${rich(e.notes,{italic:true})}<br/>` : ""}
        ${(e.tags && e.tags.length) ? `<span class="tags">Tags: ${e.tags.map(esc).join(", ")}</span>` : ""}
        <div class="item-actions">
          <button type="button" data-edit="${e.id}" class="secondary">Edit</button>
          <button type="button" data-del="${e.id}" class="danger">Delete</button>
        </div>`;
      list.appendChild(li);
    }
  }

  function startListener() {
    if (!uid) return;
    if (unsubscribe) unsubscribe();

    const col = collection(db, "users", uid, "entries");
    const qy  = query(col, orderBy("term"));

    unsubscribe = onSnapshot(qy, snap => {
      items = snap.docs.map(d => ({ id: d.id, ...d.data(), tags: d.data().tags || [] }));
      renderTagFilters();
      render();
    });
  }

  // ----- auth -----
  onAuthStateChanged(auth, user => {
    uid = user ? user.uid : null;

    btnSignIn.style.display = user ? "none" : "inline-block";
    btnSignOut.style.display = user ? "inline-block" : "none";
    btnImport.disabled = !user;
    btnExport.disabled = !user || !items.length;

    if (unsubscribe) { unsubscribe(); unsubscribe = null; }

    if (!uid) { items = []; cancelEdit(); renderTagFilters(); render(); return; }
    startListener();
  });

  btnSignIn.onclick = async () => {
    try {
      await signInWithPopup(auth, new GoogleAuthProvider()).catch(async () => {
        await signInAnonymously(auth);
      });
    } catch (e) { alert("Sign-in failed: " + e.message); }
  };
  btnSignOut.onclick = () => signOut(auth);
  btnCancelEdit.onclick = () => cancelEdit();

  // ----- import / export -----
  btnImport.onclick = () => { if (!uid) return alert("Please sign in first."); fileInput.click(); };

  btnExport.onclick = () => {
    if (!uid) return alert("Please sign in first.");
    if (!items.length) return alert("No entries to export yet.");

    const rows = items.map(e => ({
      Term: e.term, Definition: e.definition, Notes: e.notes || "", Tags: (e.tags||[]).join(", ")
    }));
    const book = XLSX.utils.book_new();
    const sheet = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(book, sheet, "Glossary");
    const date = new Date().toISOString().slice(0,10);
    XLSX.writeFile(book, `glossary-${date}.xlsx`);
  };

  fileInput.onchange = async () => {
    const file = fileInput.files[0];
    if (!file) return;
    if (!uid) { alert("Please sign in first."); fileInput.value = ""; return; }

    const original = btnImport.textContent;
    btnImport.disabled = true; btnImport.textContent = "Importingâ€¦";

    try {
      const data = await file.arrayBuffer();
      const book = XLSX.read(data, { type: "array" });
      if (!book.SheetNames.length) return alert("No sheets found in this file.");

      const sheet = book.Sheets[book.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
      if (!rows.length) return alert("No data found in the first sheet.");

      let created = 0, failed = 0;
      for (const row of rows) {
        const map = Object.fromEntries(Object.entries(row).map(([k,v]) => [String(k).trim().toLowerCase(), v]));
        const term = String(map.term ?? "").trim();
        const definition = String(map.definition ?? "").trim();
        const notes = String(map.notes ?? "").trim();
        const tagsRaw = String(map.tags ?? "").trim();
        if (!term || !definition) continue;

        const tags = tagsRaw ? tagsRaw.split(/[,;]/).map(s=>s.trim()).filter(Boolean) : [];
        try {
          await addDoc(collection(db,"users",uid,"entries"), {
            term, definition, notes: notes || null, tags,
            createdAt: serverTimestamp(), updatedAt: serverTimestamp()
          });
          created++;
        } catch (err) { console.error("Row failed", row, err); failed++; }
      }

      if (!created && !failed) alert("No valid rows found to import.");
      else if (failed && created) alert(`Imported ${created}, ${failed} failed. Check console.`);
      else if (failed && !created) alert("Import failed for all rows. Check console.");
      else alert(`Imported ${created} successfully.`);
    } catch (e) {
      console.error(e); alert("Import failed: " + e.message);
    } finally {
      btnImport.textContent = original;
      btnImport.disabled = !uid;
      fileInput.value = "";
    }
  };

  // ----- add / edit / delete -----
  form.onsubmit = async ev => {
    ev.preventDefault();
    if (!uid) return alert("Please sign in first.");

    const term = termInput.value.trim();
    const definition = definitionInput.value.trim();
    const notes = notesInput.value.trim();
    const tags = tagsInput.value.split(",").map(s=>s.trim()).filter(Boolean);
    if (!term || !definition) return;

    btnSubmit.disabled = true;

    try {
      if (editingId) {
        await updateDoc(doc(db,"users",uid,"entries",editingId), {
          term, definition, notes: notes || null, tags, updatedAt: serverTimestamp()
        });
      } else {
        await addDoc(collection(db,"users",uid,"entries"), {
          term, definition, notes: notes || null, tags,
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        });
      }
      cancelEdit();
    } catch (e) {
      alert("Could not save entry: " + e.message);
      btnSubmit.disabled = false;
    }
  };

  list.onclick = async ev => {
    const editId = ev.target.getAttribute("data-edit");
    if (editId) { const entry = items.find(it => it.id === editId); if (entry) beginEdit(entry); return; }

    const id = ev.target.getAttribute("data-del");
    if (!id) return;
    if (!confirm("Delete this entry?")) return;
    await deleteDoc(doc(db,"users",uid,"entries",id));
  };

  search.oninput = render;
  tagFilters.onclick = ev => {
    const tag = ev.target?.dataset?.tag;
    if (tag === undefined) return;
    selectedTag = tag || null;
    renderTagFilters(); render();
  };
</script>
</body>
</html>
